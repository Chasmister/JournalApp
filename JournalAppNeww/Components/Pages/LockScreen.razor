@using JournalAppNeww.Services
@using System.Security.Cryptography
@using System.Text
@inject DatabaseService DatabaseService

<div class="lock-screen">
    <div class="lock-content">
        <div class="lock-icon">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                <path d="M6 22C5.45 22 4.97917 21.8042 4.5875 21.4125C4.19583 21.0208 4 20.55 4 20V10C4 9.45 4.19583 8.97917 4.5875 8.5875C4.97917 8.19583 5.45 8 6 8H7V6C7 4.61667 7.4875 3.4375 8.4625 2.4625C9.4375 1.4875 10.6167 1 12 1C13.3833 1 14.5625 1.4875 15.5375 2.4625C16.5125 3.4375 17 4.61667 17 6V8H18C18.55 8 19.0208 8.19583 19.4125 8.5875C19.8042 8.97917 20 9.45 20 10V20C20 20.55 19.8042 21.0208 19.4125 21.4125C19.0208 21.8042 18.55 22 18 22H6ZM12 17C12.55 17 13.0208 16.8042 13.4125 16.4125C13.8042 16.0208 14 15.55 14 15C14 14.45 13.8042 13.9792 13.4125 13.5875C13.0208 13.1958 12.55 13 12 13C11.45 13 10.9792 13.1958 10.5875 13.5875C10.1958 13.9792 10 14.45 10 15C10 15.55 10.1958 16.0208 10.5875 16.4125C10.9792 16.8042 11.45 17 12 17ZM9 8H15V6C15 5.16667 14.7083 4.45833 14.125 3.875C13.5417 3.29167 12.8333 3 12 3C11.1667 3 10.4583 3.29167 9.875 3.875C9.29167 4.45833 9 5.16667 9 6V8Z" fill="currentColor" />
            </svg>
        </div>
        <h2>Journal Locked</h2>
        <p>Please enter your password to continue</p>

        <div class="form-group">
            <input type="password" 
                   class="form-input" 
                   @bind="password" 
                   @onkeyup="HandleKeyUp"
                   placeholder="Enter password" />
        </div>

        <button class="btn btn-primary" @onclick="VerifyPassword">Unlock</button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">@errorMessage</div>
        }
    </div>
</div>

<style>
    .lock-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--background-color);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }

    .lock-content {
        background-color: var(--card-background);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        width: 90%;
        max-width: 400px;
        border: 1px solid var(--border-color);
    }

    .lock-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .form-group {
        margin: 1.5rem 0;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 1rem;
    }

    .btn {
        width: 100%;
        padding: 0.75rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .error-message {
        color: #dc3545;
        margin-top: 1rem;
        font-size: 0.9rem;
    }
</style>

@code {
    [Parameter]
    public EventCallback OnUnlocked { get; set; }

    private string password = "";
    private string errorMessage = "";
    private string storedHash = "";

    protected override async Task OnInitializedAsync()
    {
        var settings = await DatabaseService.GetSettingsAsync();
        storedHash = settings.PasswordHash;
    }

    private async Task VerifyPassword()
    {
        if (HashPassword(password) == storedHash)
        {
            errorMessage = "";
            await OnUnlocked.InvokeAsync();
        }
        else
        {
            errorMessage = "Incorrect password";
            password = "";
        }
    }

    private void HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = VerifyPassword();
        }
    }

    private string HashPassword(string password)
    {
        using (SHA256 sha256 = SHA256.Create())
        {
            byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
            return Convert.ToBase64String(bytes);
        }
    }
}
