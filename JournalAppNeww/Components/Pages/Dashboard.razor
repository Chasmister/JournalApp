@page "/"
@using JournalAppNeww.Models
@using JournalAppNeww.Services
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation

<div class="dashboard-page">
    <div class="dashboard-header">
        <h1>Welcome to Your Journal</h1>
        <p class="subtitle">@GetGreeting()</p>
    </div>

    <div class="dashboard-grid">
        <!-- Quick Stats -->
        <div class="stat-card">
            <div class="stat-icon">📝</div>
            <div class="stat-content">
                <h3>@totalEntries</h3>
                <p>Total Entries</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">🔥</div>
            <div class="stat-content">
                <h3>@currentStreak</h3>
                <p>Current Streak</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">📊</div>
            <div class="stat-content">
                <h3>@totalWords</h3>
                <p>Total Words</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">@GetMostFrequentMoodEmoji()</div>
            <div class="stat-content">
                <h3>@mostFrequentMood</h3>
                <p>Most Frequent Mood</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
            <button class="action-btn" @onclick="CreateTodayEntry">
                <span class="action-icon">✍️</span>
                <span>Write Today's Entry</span>
            </button>
            <button class="action-btn" @onclick="ViewCalendar">
                <span class="action-icon">📅</span>
                <span>View Calendar</span>
            </button>
            <button class="action-btn" @onclick="ViewAllEntries">
                <span class="action-icon">📖</span>
                <span>Browse All Entries</span>
            </button>
        </div>
    </div>

    <!-- Recent Entries -->
    <div class="recent-entries">
        <h3>Recent Entries</h3>
        @if (recentEntries.Any())
        {
            <div class="entries-list">
                @foreach (var entry in recentEntries)
                {
                    <div class="entry-card" @onclick="() => ViewEntry(entry)">
                        <div class="entry-card-header">
                            <h4>@entry.Date.ToString("MMMM dd, yyyy")</h4>
                            @if (!string.IsNullOrEmpty(entry.PrimaryMood))
                            {
                                <span class="entry-mood">@GetMoodEmoji(entry.PrimaryMood)</span>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(entry.Title))
                        {
                            <div class="entry-title">@entry.Title</div>
                        }
                        <div class="entry-preview">
                            @GetContentPreview(entry.Content)
                        </div>
                        <div class="entry-meta">
                            <span>@entry.WordCount words</span>
                            <span>@entry.UpdatedAt.ToString("g")</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No entries yet. Start journaling today! ✨</p>
                <button class="btn btn-primary" @onclick="CreateTodayEntry">Create Your First Entry</button>
            </div>
        }
    </div>
</div>

@code {
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int totalWords = 0;
    private string mostFrequentMood = "N/A";
    private List<JournalEntry> recentEntries = new List<JournalEntry>();

    private Dictionary<string, string> moodEmojis = new Dictionary<string, string>
    {
        { "Happy", "😊" },
        { "Sad", "😢" },
        { "Angry", "😠" },
        { "Anxious", "😰" },
        { "Calm", "😌" },
        { "Excited", "🤩" },
        { "Tired", "😴" },
        { "Grateful", "🙏" },
        { "Stressed", "😫" },
        { "Confused", "😕" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        var allEntries = await DatabaseService.GetAllEntriesAsync();

        totalEntries = allEntries.Count;
        totalWords = allEntries.Sum(e => e.WordCount);

        // Get recent entries (last 5)
        recentEntries = allEntries.Take(5).ToList();

        // Calculate current streak
        currentStreak = CalculateStreak(allEntries);

        // Get most frequent mood
        mostFrequentMood = GetMostFrequentMood(allEntries);

        StateHasChanged();
    }

    private int CalculateStreak(List<JournalEntry> entries)
    {
        if (!entries.Any())
            return 0;

        var sortedDates = entries.Select(e => e.Date.Date).Distinct().OrderByDescending(d => d).ToList();

        int streak = 0;
        var checkDate = DateTime.Today;

        foreach (var date in sortedDates)
        {
            if (date == checkDate)
            {
                streak++;
                checkDate = checkDate.AddDays(-1);
            }
            else if (date < checkDate)
            {
                break;
            }
        }

        return streak;
    }

    private string GetMostFrequentMood(List<JournalEntry> entries)
    {
        if (!entries.Any())
            return "N/A";

        var moodCounts = entries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .OrderByDescending(g => g.Count())
            .FirstOrDefault();

        return moodCounts?.Key ?? "N/A";
    }

    private string GetMostFrequentMoodEmoji()
    {
        if (mostFrequentMood == "N/A")
            return "😐";

        return GetMoodEmoji(mostFrequentMood);
    }

    private string GetMoodEmoji(string mood)
    {
        return moodEmojis.TryGetValue(mood, out var emoji) ? emoji : "😐";
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12)
            return "Good morning! Ready to journal?";
        else if (hour < 18)
            return "Good afternoon! How's your day going?";
        else
            return "Good evening! Time to reflect on your day.";
    }

    private string GetContentPreview(string htmlContent)
    {
        if (string.IsNullOrEmpty(htmlContent))
            return "No content";

        // Remove HTML tags for preview
        var text = System.Text.RegularExpressions.Regex.Replace(htmlContent, "<.*?>", " ");
        text = text.Trim();

        if (text.Length > 150)
            return text.Substring(0, 150) + "...";

        return text;
    }

    private void CreateTodayEntry()
    {
        Navigation.NavigateTo($"/journal?date={DateTime.Today:yyyy-MM-dd}");
    }

    private void ViewCalendar()
    {
        Navigation.NavigateTo("/calendar");
    }

    private void ViewAllEntries()
    {
        Navigation.NavigateTo("/entries");
    }

    private void ViewEntry(JournalEntry entry)
    {
        Navigation.NavigateTo($"/journal?date={entry.Date:yyyy-MM-dd}");
    }
}