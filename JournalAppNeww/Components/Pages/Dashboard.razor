@page "/"
@using JournalAppNeww.Models
@using JournalAppNeww.Services
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation

<div class="dashboard-page">
    <div class="dashboard-header">
        <h1>Welcome to Your Journal</h1>
        <p class="subtitle">@GetGreeting()</p>
    </div>

    <div class="dashboard-grid">
        <!-- Quick Stats -->
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.25 15.75H29.75V12.25H12.25V15.75ZM31.5 40.25C29.3708 40.25 27.5115 39.5865 25.9219 38.2594C24.3323 36.9323 23.3333 35.2625 22.925 33.25H25.6375C26.0167 34.5333 26.7385 35.5833 27.8031 36.4C28.8677 37.2167 30.1 37.625 31.5 37.625C33.1917 37.625 34.6354 37.0271 35.8313 35.8313C37.0271 34.6354 37.625 33.1917 37.625 31.5C37.625 29.8083 37.0271 28.3646 35.8313 27.1688C34.6354 25.9729 33.1917 25.375 31.5 25.375C30.6542 25.375 29.8667 25.5281 29.1375 25.8344C28.4083 26.1406 27.7667 26.5708 27.2125 27.125H29.75V29.75H22.75V22.75H25.375V25.2438C26.1625 24.4854 27.0812 23.8802 28.1312 23.4281C29.1812 22.976 30.3042 22.75 31.5 22.75C33.9208 22.75 35.9844 23.6031 37.6906 25.3094C39.3969 27.0156 40.25 29.0792 40.25 31.5C40.25 33.9208 39.3969 35.9844 37.6906 37.6906C35.9844 39.3969 33.9208 40.25 31.5 40.25ZM18.5063 36.75H8.75C7.7875 36.75 6.96354 36.4073 6.27813 35.7219C5.59271 35.0365 5.25 34.2125 5.25 33.25V8.75C5.25 7.7875 5.59271 6.96354 6.27813 6.27813C6.96354 5.59271 7.7875 5.25 8.75 5.25H33.25C34.2125 5.25 35.0365 5.59271 35.7219 6.27813C36.4073 6.96354 36.75 7.7875 36.75 8.75V18.5063C35.9042 18.1854 35.0437 17.9375 34.1687 17.7625C33.2937 17.5875 32.4042 17.5 31.5 17.5C30.275 17.5 29.0938 17.6531 27.9563 17.9594C26.8188 18.2656 25.7396 18.6958 24.7188 19.25H12.25V22.75H20.5625C20.1542 23.275 19.775 23.8292 19.425 24.4125C19.075 24.9958 18.7688 25.6083 18.5063 26.25H12.25V29.75H17.5875C17.5292 30.0417 17.5 30.326 17.5 30.6031V31.5C17.5 32.4042 17.5875 33.2937 17.7625 34.1687C17.9375 35.0437 18.1854 35.9042 18.5063 36.75Z" fill="currentColor"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@totalEntries</h3>
                <p>Total Entries</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 24.5C7 21.4375 7.72917 18.7104 9.1875 16.3188C10.6458 13.9271 12.25 11.9146 14 10.2812C15.75 8.64792 17.3542 7.40104 18.8125 6.54063L21 5.25V11.025C21 12.1042 21.3646 12.9573 22.0938 13.5844C22.8229 14.2115 23.6396 14.525 24.5438 14.525C25.0396 14.525 25.5135 14.4229 25.9656 14.2188C26.4177 14.0146 26.8333 13.6792 27.2125 13.2125L28 12.25C30.1 13.475 31.7917 15.174 33.075 17.3469C34.3583 19.5198 35 21.9042 35 24.5C35 27.0667 34.3729 29.4073 33.1188 31.5219C31.8646 33.6365 30.2167 35.3063 28.175 36.5312C28.6708 35.8312 29.0573 35.0656 29.3344 34.2344C29.6115 33.4031 29.75 32.5208 29.75 31.5875C29.75 30.4208 29.5312 29.3198 29.0938 28.2844C28.6562 27.249 28.0292 26.3229 27.2125 25.5062L21 19.425L14.8312 25.5062C13.9854 26.3521 13.3438 27.2854 12.9062 28.3063C12.4688 29.3271 12.25 30.4208 12.25 31.5875C12.25 32.5208 12.3885 33.4031 12.6656 34.2344C12.9427 35.0656 13.3292 35.8312 13.825 36.5312C11.7833 35.3063 10.1354 33.6365 8.88125 31.5219C7.62708 29.4073 7 27.0667 7 24.5ZM21 24.325L24.7188 27.9563C25.2146 28.4521 25.5938 29.0063 25.8563 29.6188C26.1188 30.2313 26.25 30.8875 26.25 31.5875C26.25 33.0167 25.7396 34.2344 24.7188 35.2406C23.6979 36.2469 22.4583 36.75 21 36.75C19.5417 36.75 18.3021 36.2469 17.2812 35.2406C16.2604 34.2344 15.75 33.0167 15.75 31.5875C15.75 30.9167 15.8812 30.2677 16.1437 29.6406C16.4062 29.0135 16.7854 28.4521 17.2812 27.9563L21 24.325Z" fill="currentColor"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@currentStreak</h3>
                <p>Current Streak</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4.375 35.875V33.25H37.625V35.875H4.375ZM6.125 30.8267V20.125H10.5V30.8267H6.125ZM14.5722 30.8267V11.375H18.9472V30.8267H14.5722ZM23.0361 30.8267V16.625H27.4111V30.8267H23.0361ZM31.5 30.8267V6.125H35.875V30.8267H31.5Z" fill="currentColor"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>@totalWords</h3>
                <p>Total Words</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">@GetMostFrequentMoodEmoji()</div>
            <div class="stat-content">
                <h3>@mostFrequentMood</h3>
                <p>Most Frequent Mood</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
            <button class="action-btn" @onclick="CreateTodayEntry">
                <span class="action-icon">
                    <svg width="24" height="24" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7 36.75V29.3125L30.0563 6.3C30.4063 5.95 30.8 5.6875 31.2375 5.5125C31.675 5.3375 32.1125 5.25 32.55 5.25C33.0167 5.25 33.4615 5.3375 33.8844 5.5125C34.3073 5.6875 34.6792 5.95 35 6.3L37.45 8.75C37.8 9.07083 38.0625 9.44271 38.2375 9.86563C38.4125 10.2885 38.5 10.7333 38.5 11.2C38.5 11.6375 38.4125 12.075 38.2375 12.5125C38.0625 12.95 37.8 13.3438 37.45 13.6938L14.4375 36.75H7ZM32.6375 13.6063L35 11.2437L32.5062 8.75L30.1438 11.1125L32.6375 13.6063ZM24.5 36.75C26.6583 36.75 28.6563 36.2104 30.4938 35.1313C32.3313 34.0521 33.25 32.55 33.25 30.625C33.25 29.575 32.9729 28.6708 32.4188 27.9125C31.8646 27.1542 31.1208 26.4979 30.1875 25.9437L27.6063 28.525C28.2771 28.8167 28.8021 29.1375 29.1813 29.4875C29.5604 29.8375 29.75 30.2167 29.75 30.625C29.75 31.2958 29.2177 31.901 28.1531 32.4406C27.0885 32.9802 25.8708 33.25 24.5 33.25C24.0042 33.25 23.5885 33.4177 23.2531 33.7531C22.9177 34.0885 22.75 34.5042 22.75 35C22.75 35.4958 22.9177 35.9115 23.2531 36.2469C23.5885 36.5823 24.0042 36.75 24.5 36.75ZM8.00625 23.3625L10.6313 20.7375C10.0479 20.5042 9.58854 20.2635 9.25313 20.0156C8.91771 19.7677 8.75 19.5125 8.75 19.25C8.75 18.9 9.0125 18.55 9.5375 18.2C10.0625 17.85 11.1708 17.3104 12.8625 16.5812C15.4292 15.4729 17.1354 14.4667 17.9813 13.5625C18.8271 12.6583 19.25 11.6375 19.25 10.5C19.25 8.89583 18.6083 7.61979 17.325 6.67188C16.0417 5.72396 14.35 5.25 12.25 5.25C10.9375 5.25 9.76354 5.48333 8.72813 5.95C7.69271 6.41667 6.89792 6.98542 6.34375 7.65625C6.02292 8.03542 5.89167 8.45833 5.95 8.925C6.00833 9.39167 6.22708 9.77083 6.60625 10.0625C6.98542 10.3833 7.40833 10.5146 7.875 10.4563C8.34167 10.3979 8.73542 10.2083 9.05625 9.8875C9.46458 9.47917 9.91667 9.1875 10.4125 9.0125C10.9083 8.8375 11.5208 8.75 12.25 8.75C13.4458 8.75 14.3281 8.925 14.8969 9.275C15.4656 9.625 15.75 10.0333 15.75 10.5C15.75 10.9083 15.4948 11.2802 14.9844 11.6156C14.474 11.951 13.3 12.5417 11.4625 13.3875C9.12917 14.4083 7.51042 15.3344 6.60625 16.1656C5.70208 16.9969 5.25 18.025 5.25 19.25C5.25 20.1833 5.49792 20.9781 5.99375 21.6344C6.48958 22.2906 7.16042 22.8667 8.00625 23.3625Z" fill="currentColor"/>
                    </svg>
                </span>
                <span>Write Today's Entry</span>
            </button>
            <button class="action-btn" @onclick="ViewCalendar">
                <span class="action-icon">
                    <svg width="24" height="24" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 24.5C20.5042 24.5 20.0885 24.3323 19.7531 23.9969C19.4177 23.6615 19.25 23.2458 19.25 22.75C19.25 22.2542 19.4177 21.8385 19.7531 21.5031C20.0885 21.1677 20.5042 21 21 21C21.4958 21 21.9115 21.1677 22.2469 21.5031C22.5823 21.8385 22.75 22.2542 22.75 22.75C22.75 23.2458 22.5823 23.6615 22.2469 23.9969C21.9115 24.3323 21.4958 24.5 21 24.5ZM14 24.5C13.5042 24.5 13.0885 24.3323 12.7531 23.9969C12.4177 23.6615 12.25 23.2458 12.25 22.75C12.25 22.2542 12.4177 21.8385 12.7531 21.5031C13.0885 21.1677 13.5042 21 14 21C14.4958 21 14.9115 21.1677 15.2469 21.5031C15.5823 21.8385 15.75 22.2542 15.75 22.75C15.75 23.2458 15.5823 23.6615 15.2469 23.9969C14.9115 24.3323 14.4958 24.5 14 24.5ZM28 24.5C27.5042 24.5 27.0885 24.3323 26.7531 23.9969C26.4177 23.6615 26.25 23.2458 26.25 22.75C26.25 22.2542 26.4177 21.8385 26.7531 21.5031C27.0885 21.1677 27.5042 21 28 21C28.4958 21 28.9115 21.1677 29.2469 21.5031C29.5823 21.8385 29.75 22.2542 29.75 22.75C29.75 23.2458 29.5823 23.6615 29.2469 23.9969C28.9115 24.3323 28.4958 24.5 28 24.5ZM21 31.5C20.5042 31.5 20.0885 31.3323 19.7531 30.9969C19.4177 30.6615 19.25 30.2458 19.25 29.75C19.25 29.2542 19.4177 28.8385 19.7531 28.5031C20.0885 28.1677 20.5042 28 21 28C21.4958 28 21.9115 28.1677 22.2469 28.5031C22.5823 28.8385 22.75 29.2542 22.75 29.75C22.75 30.2458 22.5823 30.6615 22.2469 30.9969C21.9115 31.3323 21.4958 31.5 21 31.5ZM14 31.5C13.5042 31.5 13.0885 31.3323 12.7531 30.9969C12.4177 30.6615 12.25 30.2458 12.25 29.75C12.25 29.2542 12.4177 28.8385 12.7531 28.5031C13.0885 28.1677 13.5042 28 14 28C14.4958 28 14.9115 28.1677 15.2469 28.5031C15.5823 28.8385 15.75 29.2542 15.75 29.75C15.75 30.2458 15.5823 30.6615 15.2469 30.9969C14.9115 31.3323 14.4958 31.5 14 31.5ZM28 31.5C27.5042 31.5 27.0885 31.3323 26.7531 30.9969C26.4177 30.6615 26.25 30.2458 26.25 29.75C26.25 29.2542 26.4177 28.8385 26.7531 28.5031C27.0885 28.1677 27.5042 28 28 28C28.4958 28 28.9115 28.1677 29.2469 28.5031C29.5823 28.8385 29.75 29.2542 29.75 29.75C29.75 30.2458 29.5823 30.6615 29.2469 30.9969C28.9115 31.3323 28.4958 31.5 28 31.5ZM8.75 38.5C7.7875 38.5 6.96354 38.1573 6.27813 37.4719C5.59271 36.7865 5.25 35.9625 5.25 35V10.5C5.25 9.5375 5.59271 8.71354 6.27813 8.02813C6.96354 7.34271 7.7875 7 8.75 7H10.5V3.5H14V7H28V3.5H31.5V7H33.25C34.2125 7 35.0365 7.34271 35.7219 8.02813C36.4073 8.71354 36.75 9.5375 36.75 10.5V35C36.75 35.9625 36.4073 36.7865 35.7219 37.4719C35.0365 38.1573 34.2125 38.5 33.25 38.5H8.75ZM8.75 35H33.25V17.5H8.75V35Z" fill="currentColor"/>
                    </svg>
                </span>
                <span>View Calendar</span>
            </button>
            <button class="action-btn" @onclick="ViewAllEntries">
                <span class="action-icon">
                    <svg width="24" height="24" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8.83721 39.1562L6.38721 36.6625L11.5497 31.5H7.61221V28H17.4997V37.8875H13.9997V33.9938L8.83721 39.1562ZM20.9997 38.5V24.5H6.99971V7C6.99971 6.0375 7.34242 5.21354 8.02783 4.52813C8.71325 3.84271 9.53721 3.5 10.4997 3.5H24.4997L34.9997 14V35C34.9997 35.9625 34.657 36.7865 33.9716 37.4719C33.2862 38.1573 32.4622 38.5 31.4997 38.5H20.9997ZM22.7497 15.75H31.4997L22.7497 7V15.75Z" fill="currentColor"/>
                    </svg>
                </span>
                <span>Browse All Entries</span>
            </button>
        </div>
    </div>

    <!-- Recent Entries -->
    <div class="recent-entries">
        <h3>Recent Entries</h3>
        @if (recentEntries.Any())
        {
            <div class="entries-list">
                @foreach (var entry in recentEntries)
                {
                    <div class="entry-card" @onclick="() => ViewEntry(entry)">
                        <div class="entry-card-header">
                            <h4>@entry.Date.ToString("MMMM dd, yyyy")</h4>
                            @if (!string.IsNullOrEmpty(entry.PrimaryMood))
                            {
                                <span class="entry-mood">@GetMoodEmoji(entry.PrimaryMood)</span>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(entry.Title))
                        {
                            <div class="entry-title">@entry.Title</div>
                        }
                        <div class="entry-preview">
                            @GetContentPreview(entry.Content)
                        </div>
                        <div class="entry-meta">
                            <span>@entry.WordCount words</span>
                            <span>@entry.UpdatedAt.ToString("g")</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No entries yet. Start journaling today! ✨</p>
                <button class="btn btn-primary" @onclick="CreateTodayEntry">Create Your First Entry</button>
            </div>
        }
    </div>
</div>

@code {
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int totalWords = 0;
    private string mostFrequentMood = "N/A";
    private List<JournalEntry> recentEntries = new List<JournalEntry>();

    private Dictionary<string, string> moodEmojis = new Dictionary<string, string>
    {
        { "Happy", "😊" },
        { "Sad", "😢" },
        { "Angry", "😠" },
        { "Anxious", "😰" },
        { "Calm", "😌" },
        { "Excited", "🤩" },
        { "Tired", "😴" },
        { "Grateful", "🙏" },
        { "Stressed", "😫" },
        { "Confused", "😕" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        var allEntries = await DatabaseService.GetAllEntriesAsync();

        totalEntries = allEntries.Count;
        totalWords = allEntries.Sum(e => e.WordCount);

        // Get recent entries (last 5)
        recentEntries = allEntries.Take(5).ToList();

        // Calculate current streak
        currentStreak = CalculateStreak(allEntries);

        // Get most frequent mood
        mostFrequentMood = GetMostFrequentMood(allEntries);

        StateHasChanged();
    }

    private int CalculateStreak(List<JournalEntry> entries)
    {
        if (!entries.Any())
            return 0;

        var sortedDates = entries.Select(e => e.Date.Date).Distinct().OrderByDescending(d => d).ToList();

        int streak = 0;
        var checkDate = DateTime.Today;

        foreach (var date in sortedDates)
        {
            if (date == checkDate)
            {
                streak++;
                checkDate = checkDate.AddDays(-1);
            }
            else if (date < checkDate)
            {
                break;
            }
        }

        return streak;
    }

    private string GetMostFrequentMood(List<JournalEntry> entries)
    {
        if (!entries.Any())
            return "N/A";

        var moodCounts = entries
            .Where(e => !string.IsNullOrEmpty(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood)
            .OrderByDescending(g => g.Count())
            .FirstOrDefault();

        return moodCounts?.Key ?? "N/A";
    }

    private string GetMostFrequentMoodEmoji()
    {
        if (mostFrequentMood == "N/A")
            return "😐";

        return GetMoodEmoji(mostFrequentMood);
    }

    private string GetMoodEmoji(string mood)
    {
        return moodEmojis.TryGetValue(mood, out var emoji) ? emoji : "😐";
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12)
            return "Good morning! Ready to journal?";
        else if (hour < 18)
            return "Good afternoon! How's your day going?";
        else
            return "Good evening! Time to reflect on your day.";
    }

    private string GetContentPreview(string htmlContent)
    {
        if (string.IsNullOrEmpty(htmlContent))
            return "No content";

        // Remove HTML tags for preview
        var text = System.Text.RegularExpressions.Regex.Replace(htmlContent, "<.*?>", " ");
        text = text.Trim();

        if (text.Length > 150)
            return text.Substring(0, 150) + "...";

        return text;
    }

    private void CreateTodayEntry()
    {
        Navigation.NavigateTo($"/journal?date={DateTime.Today:yyyy-MM-dd}");
    }

    private void ViewCalendar()
    {
        Navigation.NavigateTo("/calendar");
    }

    private void ViewAllEntries()
    {
        Navigation.NavigateTo("/entries");
    }

    private void ViewEntry(JournalEntry entry)
    {
        Navigation.NavigateTo($"/journal?date={entry.Date:yyyy-MM-dd}");
    }
}