@page "/settings"
@using JournalAppNeww.Models
@using JournalAppNeww.Services
@using System.Security.Cryptography
@using System.Text
@inject DatabaseService DatabaseService
@inject ThemeService ThemeService
@inject IJSRuntime JSRuntime

<div class="settings-page">
    <div class="settings-header">
        <h2>Settings</h2>
        <p class="subtitle">Customize your journal experience</p>
    </div>

    <!-- Theme Settings -->
    <div class="settings-section">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                <path d="M12 22C10.9 22 9.95833 21.6083 9.175 20.825C8.39167 20.0417 8 19.1 8 18H16C16 19.1 15.6083 20.0417 14.825 20.825C14.0417 21.6083 13.1 22 12 22ZM12 2C13.3833 2 14.5625 2.4875 15.5375 3.4625C16.5125 4.4375 17 5.61667 17 7C17 7.76667 16.8417 8.49583 16.525 9.1875C16.2083 9.87917 15.7667 10.4833 15.2 11L13.6 9.4C14.0167 9.01667 14.3333 8.5625 14.55 8.0375C14.7667 7.5125 14.875 6.96667 14.875 6.4C14.875 5.51667 14.5667 4.77083 13.95 4.1625C13.3333 3.55417 12.5833 3.25 11.7 3.25C10.8167 3.25 10.0667 3.55417 9.45 4.1625C8.83333 4.77083 8.525 5.51667 8.525 6.4C8.525 6.96667 8.63333 7.5125 8.85 8.0375C9.06667 8.5625 9.38333 9.01667 9.8 9.4L8.2 11C7.63333 10.4833 7.19167 9.87917 6.875 9.1875C6.55833 8.49583 6.4 7.76667 6.4 7C6.4 5.61667 6.8875 4.4375 7.8625 3.4625C8.8375 2.4875 10.0167 2 11.4 2H12ZM7.05 14L5.65 12.6L9.4 8.85L10.8 10.25L7.05 14ZM16.35 12.6L14.95 14L11.2 10.25L12.6 8.85L16.35 12.6Z" fill="currentColor"/>
            </svg>
            Theme
        </h3>
        <p class="section-description">Choose your preferred theme or create a custom one</p>

        <div class="theme-options">
            <div class="theme-option @(currentTheme == "light" ? "selected" : "")"
                 @onclick='() => ChangeTheme("light")'>
                <div class="theme-preview light-preview">
                    <div class="preview-sidebar"></div>
                    <div class="preview-content"></div>
                </div>
                <span class="theme-name">Light</span>
            </div>

            <div class="theme-option @(currentTheme == "dark" ? "selected" : "")"
                 @onclick='() => ChangeTheme("dark")'>
                <div class="theme-preview dark-preview">
                    <div class="preview-sidebar"></div>
                    <div class="preview-content"></div>
                </div>
                <span class="theme-name">Dark</span>
            </div>

            <div class="theme-option @(currentTheme == "custom" ? "selected" : "")"
                 @onclick="() => showCustomTheme = !showCustomTheme">
                <div class="theme-preview custom-preview">
                    <div class="preview-sidebar" style="background-color: @settings.SidebarColor"></div>
                    <div class="preview-content" style="background-color: @settings.BackgroundColor"></div>
                </div>
                <span class="theme-name">Custom</span>
            </div>
        </div>

        @if (showCustomTheme || currentTheme == "custom")
        {
            <div class="custom-theme-editor">
                <h4>Custom Theme Colors</h4>
                <div class="color-inputs">
                    <div class="color-input-group">
                        <label>Primary Color:</label>
                        <input type="color" @bind="customPrimaryColor" />
                        <span class="color-value">@customPrimaryColor</span>
                    </div>
                    <div class="color-input-group">
                        <label>Background Color:</label>
                        <input type="color" @bind="customBackgroundColor" />
                        <span class="color-value">@customBackgroundColor</span>
                    </div>
                    <div class="color-input-group">
                        <label>Sidebar Color:</label>
                        <input type="color" @bind="customSidebarColor" />
                        <span class="color-value">@customSidebarColor</span>
                    </div>
                    <div class="color-input-group">
                        <label>Text Color:</label>
                        <input type="color" @bind="customTextColor" />
                        <span class="color-value">@customTextColor</span>
                    </div>
                </div>
                <button class="btn btn-primary" @onclick="ApplyCustomTheme">Apply Custom Theme</button>
            </div>
        }
    </div>

    <!-- Security Settings -->
    <div class="settings-section">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                <path d="M6 22C5.45 22 4.97917 21.8042 4.5875 21.4125C4.19583 21.0208 4 20.55 4 20V10C4 9.45 4.19583 8.97917 4.5875 8.5875C4.97917 8.19583 5.45 8 6 8H7V6C7 4.61667 7.4875 3.4375 8.4625 2.4625C9.4375 1.4875 10.6167 1 12 1C13.3833 1 14.5625 1.4875 15.5375 2.4625C16.5125 3.4375 17 4.61667 17 6V8H18C18.55 8 19.0208 8.19583 19.4125 8.5875C19.8042 8.97917 20 9.45 20 10V20C20 20.55 19.8042 21.0208 19.4125 21.4125C19.0208 21.8042 18.55 22 18 22H6ZM12 17C12.55 17 13.0208 16.8042 13.4125 16.4125C13.8042 16.0208 14 15.55 14 15C14 14.45 13.8042 13.9792 13.4125 13.5875C13.0208 13.1958 12.55 13 12 13C11.45 13 10.9792 13.1958 10.5875 13.5875C10.1958 13.9792 10 14.45 10 15C10 15.55 10.1958 16.0208 10.5875 16.4125C10.9792 16.8042 11.45 17 12 17ZM9 8H15V6C15 5.16667 14.7083 4.45833 14.125 3.875C13.5417 3.29167 12.8333 3 12 3C11.1667 3 10.4583 3.29167 9.875 3.875C9.29167 4.45833 9 5.16667 9 6V8Z" fill="currentColor"/>
            </svg>
            Security & Privacy
        </h3>
        <p class="section-description">Protect your journal with a password</p>

        <div class="security-toggle">
            <label class="toggle-label">
                <input type="checkbox"
                       checked="@settings.PasswordEnabled"
                       @onchange="TogglePasswordProtection" />
                <span class="toggle-text">Enable Password Protection</span>
            </label>
        </div>

        @if (showPasswordSetup)
        {
            <div class="password-setup">
                <h4>@(settings.PasswordEnabled ? "Change Password" : "Set Password")</h4>

                @if (settings.PasswordEnabled && !passwordVerified)
                {
                    <div class="form-group">
                        <label>Current Password:</label>
                        <input type="password"
                               class="form-input"
                               @bind="currentPassword"
                               placeholder="Enter current password" />
                    </div>
                    <button class="btn btn-secondary" @onclick="VerifyCurrentPassword">Verify</button>
                }
                else if (!settings.PasswordEnabled || passwordVerified)
                {
                    <div class="form-group">
                        <label>New Password:</label>
                        <input type="password"
                               class="form-input"
                               @bind="newPassword"
                               placeholder="Enter new password" />
                    </div>
                    <div class="form-group">
                        <label>Confirm Password:</label>
                        <input type="password"
                               class="form-input"
                               @bind="confirmPassword"
                               placeholder="Confirm password" />
                    </div>
                    <button class="btn btn-primary" @onclick="SavePassword">Save Password</button>
                }

                @if (!string.IsNullOrEmpty(passwordMessage))
                {
                    <div class="message @passwordMessageClass">@passwordMessage</div>
                }
            </div>
        }
    </div>

    <!-- Data Management -->
    <div class="settings-section">
        <h3>💾 Data Management</h3>
        <p class="section-description">Manage your journal data</p>

        <div class="data-stats">
            <div class="data-stat-item">
                <span class="stat-label">Total Entries:</span>
                <span class="stat-value">@totalEntries</span>
            </div>
            <div class="data-stat-item">
                <span class="stat-label">Total Tags:</span>
                <span class="stat-value">@totalTags</span>
            </div>
            <div class="data-stat-item">
                <span class="stat-label">Total Words:</span>
                <span class="stat-value">@totalWords</span>
            </div>
        </div>

        <div class="data-actions">
            <button class="btn btn-danger" @onclick="ClearAllData">Clear All Data</button>
            <p class="warning-text">⚠️ This action cannot be undone!</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusClass">
            @statusMessage
        </div>
    }
</div>

@code {
    private AppSettings settings = new AppSettings();
    private string currentTheme = "light";
    private bool showCustomTheme = false;
    private bool showPasswordSetup = false;
    private bool passwordVerified = false;

    // Custom theme colors
    private string customPrimaryColor = "#007bff";
    private string customBackgroundColor = "#ffffff";
    private string customSidebarColor = "#2c3e50";
    private string customTextColor = "#333333";

    // Password fields
    private string currentPassword = string.Empty;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;
    private string passwordMessage = string.Empty;
    private string passwordMessageClass = string.Empty;

    // Data stats
    private int totalEntries = 0;
    private int totalTags = 0;
    private int totalWords = 0;

    private string statusMessage = string.Empty;
    private string statusClass = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        await LoadDataStats();
    }

    private async Task LoadSettings()
    {
        settings = await DatabaseService.GetSettingsAsync();
        currentTheme = settings.Theme;

        customPrimaryColor = settings.PrimaryColor;
        customBackgroundColor = settings.BackgroundColor;
        customSidebarColor = settings.SidebarColor;
        customTextColor = settings.TextColor;
    }

    private async Task LoadDataStats()
    {
        var entries = await DatabaseService.GetAllEntriesAsync();
        totalEntries = entries.Count;
        totalWords = entries.Sum(e => e.WordCount);

        var tags = await DatabaseService.GetAllTagsAsync();
        totalTags = tags.Count;
    }

    private async Task ChangeTheme(string theme)
    {
        currentTheme = theme;
        await ThemeService.SetThemeAsync(theme);

        statusMessage = $"Theme changed to {theme}";
        statusClass = "success";
        StateHasChanged();
    }

    private async Task ApplyCustomTheme()
    {
        await ThemeService.SetCustomColorsAsync(
            customPrimaryColor,
            customBackgroundColor,
            customSidebarColor,
            customTextColor
        );

        currentTheme = "custom";
        statusMessage = "Custom theme applied successfully!";
        statusClass = "success";
        StateHasChanged();
    }

    private void TogglePasswordProtection(ChangeEventArgs e)
    {
        var enabled = (bool)(e.Value ?? false);

        if (enabled)
        {
            showPasswordSetup = true;
            passwordVerified = false;
        }
        else
        {
            showPasswordSetup = true;
        }
    }

    private void VerifyCurrentPassword()
    {
        var hashedInput = HashPassword(currentPassword);

        if (hashedInput == settings.PasswordHash)
        {
            passwordVerified = true;
            passwordMessage = "Password verified! You can now set a new password.";
            passwordMessageClass = "success";
        }
        else
        {
            passwordMessage = "Incorrect password. Please try again.";
            passwordMessageClass = "error";
        }

        currentPassword = string.Empty;
        StateHasChanged();
    }

    private async Task SavePassword()
    {
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            passwordMessage = "Password cannot be empty.";
            passwordMessageClass = "error";
            return;
        }

        if (newPassword != confirmPassword)
        {
            passwordMessage = "Passwords do not match.";
            passwordMessageClass = "error";
            return;
        }

        if (newPassword.Length < 4)
        {
            passwordMessage = "Password must be at least 4 characters long.";
            passwordMessageClass = "error";
            return;
        }

        settings.PasswordHash = HashPassword(newPassword);
        settings.PasswordEnabled = true;
        await DatabaseService.SaveSettingsAsync(settings);

        passwordMessage = "Password set successfully!";
        passwordMessageClass = "success";

        newPassword = string.Empty;
        confirmPassword = string.Empty;
        showPasswordSetup = false;
        passwordVerified = false;

        StateHasChanged();
    }

    private string HashPassword(string password)
    {
        using (SHA256 sha256 = SHA256.Create())
        {
            byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(password));
            return Convert.ToBase64String(bytes);
        }
    }

    private async Task ClearAllData()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            "Are you sure you want to delete ALL journal data? This cannot be undone!");

        if (confirmed)
        {
            var doubleConfirm = await JSRuntime.InvokeAsync<bool>("confirm",
                "This is your last warning! All entries, tags, and settings will be permanently deleted. Continue?");

            if (doubleConfirm)
            {
                // This would require implementing delete methods in DatabaseService
                // For now, show a message
                statusMessage = "Data clearing feature will be implemented with proper backup mechanism.";
                statusClass = "error";
            }
        }
    }
}