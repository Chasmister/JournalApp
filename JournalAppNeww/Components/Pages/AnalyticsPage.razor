@page "/analytics"
@using JournalAppNeww.Models
@using JournalAppNeww.Services
@inject DatabaseService DatabaseService

<div class="analytics-page">
    <div class="analytics-header">
        <h2>Analytics & Insights</h2>
        <p class="subtitle">Your journaling patterns and statistics</p>
    </div>

    @if (allEntries.Any())
    {
        <!-- Streak Section -->
        <div class="analytics-section">
            <h3>🔥 Journaling Streak</h3>
            <div class="streak-cards">
                <div class="streak-card highlight">
                    <div class="streak-icon">
                        <svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 24.5C7 21.4375 7.72917 18.7104 9.1875 16.3188C10.6458 13.9271 12.25 11.9146 14 10.2812C15.75 8.64792 17.3542 7.40104 18.8125 6.54063L21 5.25V11.025C21 12.1042 21.3646 12.9573 22.0938 13.5844C22.8229 14.2115 23.6396 14.525 24.5438 14.525C25.0396 14.525 25.5135 14.4229 25.9656 14.2188C26.4177 14.0146 26.8333 13.6792 27.2125 13.2125L28 12.25C30.1 13.475 31.7917 15.174 33.075 17.3469C34.3583 19.5198 35 21.9042 35 24.5C35 27.0667 34.3729 29.4073 33.1188 31.5219C31.8646 33.6365 30.2167 35.3063 28.175 36.5312C28.6708 35.8312 29.0573 35.0656 29.3344 34.2344C29.6115 33.4031 29.75 32.5208 29.75 31.5875C29.75 30.4208 29.5312 29.3198 29.0938 28.2844C28.6562 27.249 28.0292 26.3229 27.2125 25.5062L21 19.425L14.8312 25.5062C13.9854 26.3521 13.3438 27.2854 12.9062 28.3063C12.4688 29.3271 12.25 30.4208 12.25 31.5875C12.25 32.5208 12.3885 33.4031 12.6656 34.2344C12.9427 35.0656 13.3292 35.8312 13.825 36.5312C11.7833 35.3063 10.1354 33.6365 8.88125 31.5219C7.62708 29.4073 7 27.0667 7 24.5ZM21 24.325L24.7188 27.9563C25.2146 28.4521 25.5938 29.0063 25.8563 29.6188C26.1188 30.2313 26.25 30.8875 26.25 31.5875C26.25 33.0167 25.7396 34.2344 24.7188 35.2406C23.6979 36.2469 22.4583 36.75 21 36.75C19.5417 36.75 18.3021 36.2469 17.2812 35.2406C16.2604 34.2344 15.75 33.0167 15.75 31.5875C15.75 30.9167 15.8812 30.2677 16.1437 29.6406C16.4062 29.0135 16.7854 28.4521 17.2812 27.9563L21 24.325Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="streak-content">
                        <h4>@currentStreak</h4>
                        <p>Current Streak</p>
                    </div>
                </div>

                <div class="streak-card">
                    <div class="streak-icon">🏆</div>
                    <div class="streak-content">
                        <h4>@longestStreak</h4>
                        <p>Longest Streak</p>
                    </div>
                </div>

                <div class="streak-card">
                    <div class="streak-icon">
                        <svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.25 15.75H29.75V12.25H12.25V15.75ZM31.5 40.25C29.3708 40.25 27.5115 39.5865 25.9219 38.2594C24.3323 36.9323 23.3333 35.2625 22.925 33.25H25.6375C26.0167 34.5333 26.7385 35.5833 27.8031 36.4C28.8677 37.2167 30.1 37.625 31.5 37.625C33.1917 37.625 34.6354 37.0271 35.8313 35.8313C37.0271 34.6354 37.625 33.1917 37.625 31.5C37.625 29.8083 37.0271 28.3646 35.8313 27.1688C34.6354 25.9729 33.1917 25.375 31.5 25.375C30.6542 25.375 29.8667 25.5281 29.1375 25.8344C28.4083 26.1406 27.7667 26.5708 27.2125 27.125H29.75V29.75H22.75V22.75H25.375V25.2438C26.1625 24.4854 27.0812 23.8802 28.1312 23.4281C29.1812 22.976 30.3042 22.75 31.5 22.75C33.9208 22.75 35.9844 23.6031 37.6906 25.3094C39.3969 27.0156 40.25 29.0792 40.25 31.5C40.25 33.9208 39.3969 35.9844 37.6906 37.6906C35.9844 39.3969 33.9208 40.25 31.5 40.25ZM18.5063 36.75H8.75C7.7875 36.75 6.96354 36.4073 6.27813 35.7219C5.59271 35.0365 5.25 34.2125 5.25 33.25V8.75C5.25 7.7875 5.59271 6.96354 6.27813 6.27813C6.96354 5.59271 7.7875 5.25 8.75 5.25H33.25C34.2125 5.25 35.0365 5.59271 35.7219 6.27813C36.4073 6.96354 36.75 7.7875 36.75 8.75V18.5063C35.9042 18.1854 35.0437 17.9375 34.1687 17.7625C33.2937 17.5875 32.4042 17.5 31.5 17.5C30.275 17.5 29.0938 17.6531 27.9563 17.9594C26.8188 18.2656 25.7396 18.6958 24.7188 19.25H12.25V22.75H20.5625C20.1542 23.275 19.775 23.8292 19.425 24.4125C19.075 24.9958 18.7688 25.6083 18.5063 26.25H12.25V29.75H17.5875C17.5292 30.0417 17.5 30.326 17.5 30.6031V31.5C17.5 32.4042 17.5875 33.2937 17.7625 34.1687C17.9375 35.0437 18.1854 35.9042 18.5063 36.75Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="streak-content">
                        <h4>@totalDays</h4>
                        <p>Total Days Journaled</p>
                    </div>
                </div>

                <div class="streak-card">
                    <div class="streak-icon">❌</div>
                    <div class="streak-content">
                        <h4>@missedDays</h4>
                        <p>Missed Days (Last 30)</p>
                    </div>
                </div>
            </div>

            <!-- Streak Heatmap -->
            <div class="streak-heatmap">
                <h4>Last 90 Days Activity</h4>
                <div class="heatmap-grid">
                    @foreach (var day in last90Days)
                    {
                        <div class="heatmap-cell @GetHeatmapClass(day)" 
                             title="@day.ToString("MMM dd, yyyy"): @(HasEntryOnDate(day) ? "Entry exists" : "No entry")">
                        </div>
                    }
                </div>
                <div class="heatmap-legend">
                    <span>Less</span>
                    <div class="legend-cell level-0"></div>
                    <div class="legend-cell level-1"></div>
                    <div class="legend-cell level-2"></div>
                    <div class="legend-cell level-3"></div>
                    <span>More</span>
                </div>
            </div>
        </div>

        <!-- Mood Distribution -->
        <div class="analytics-section">
            <h3>😊 Mood Distribution</h3>
            <div class="mood-stats-grid">
                @foreach (var moodStat in moodDistribution.OrderByDescending(m => m.Value))
                {
                    var percentage = (moodStat.Value * 100.0 / totalEntries);
                    <div class="mood-stat-card">
                        <div class="mood-stat-header">
                            <span class="mood-emoji-big">@GetMoodEmoji(moodStat.Key)</span>
                            <span class="mood-name">@moodStat.Key</span>
                        </div>
                        <div class="mood-stat-bar">
                            <div class="mood-stat-fill" style="width: @percentage%"></div>
                        </div>
                        <div class="mood-stat-info">
                            <span class="mood-count">@moodStat.Value entries</span>
                            <span class="mood-percentage">@percentage.ToString("F1")%</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Most Frequent Mood -->
            <div class="insight-card">
                <h4>💡 Insight</h4>
                <p>Your most frequent mood is <strong>@GetMoodEmoji(mostFrequentMood) @mostFrequentMood</strong>, 
                   appearing in @moodDistribution[mostFrequentMood] of your @totalEntries entries.</p>
            </div>
        </div>

        <!-- Word Count Trends -->
        <div class="analytics-section">
            <h3>
                <svg width="20" height="20" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                    <path d="M4.375 35.875V33.25H37.625V35.875H4.375ZM6.125 30.8267V20.125H10.5V30.8267H6.125ZM14.5722 30.8267V11.375H18.9472V30.8267H14.5722ZM23.0361 30.8267V16.625H27.4111V30.8267H23.0361ZM31.5 30.8267V6.125H35.875V30.8267H31.5Z" fill="currentColor"/>
                </svg>
                Writing Statistics
            </h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number">@totalWords.ToString("N0")</div>
                    <div class="stat-label">Total Words Written</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">@averageWords.ToString("F0")</div>
                    <div class="stat-label">Average Words per Entry</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">@maxWords.ToString("N0")</div>
                    <div class="stat-label">Longest Entry</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">@minWords.ToString("N0")</div>
                    <div class="stat-label">Shortest Entry</div>
                </div>
            </div>

            <!-- Word Count Trend (Last 30 Days) -->
            <div class="trend-chart">
                <h4>Word Count Trend (Last 30 Days)</h4>
                <div class="chart-container">
                    @foreach (var entry in last30DaysEntries.OrderBy(e => e.Date))
                    {
                        var barHeight = entry.WordCount > 0 ? (entry.WordCount * 100.0 / maxWords) : 0;
                        <div class="chart-bar-container">
                            <div class="chart-bar" 
                                 style="height: @barHeight%; background-color: @GetWordCountColor(entry.WordCount)"
                                 title="@entry.Date.ToString("MMM dd"): @entry.WordCount words">
                            </div>
                            <div class="chart-label">@entry.Date.ToString("dd")</div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Tag Usage -->
        @if (tagUsage.Any())
        {
            <div class="analytics-section">
                <h3>🏷️ Tag Usage</h3>
                <div class="tag-usage-grid">
                    @foreach (var tag in tagUsage.OrderByDescending(t => t.Value).Take(10))
                    {
                        var tagInfo = allTags.FirstOrDefault(t => t.Id == tag.Key);
                        if (tagInfo != null)
                        {
                            var percentage = (tag.Value * 100.0 / totalEntries);
                            <div class="tag-usage-card">
                                <div class="tag-usage-name" style="border-left: 4px solid @tagInfo.Color">
                                    @tagInfo.Name
                                </div>
                                <div class="tag-usage-bar">
                                    <div class="tag-usage-fill" style="width: @percentage%; background-color: @tagInfo.Color"></div>
                                </div>
                                <div class="tag-usage-info">
                                    <span>@tag.Value entries</span>
                                    <span>@percentage.ToString("F1")%</span>
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="insight-card">
                    <h4>💡 Insight</h4>
                    <p>You have used <strong>@allTags.Count tags</strong> across your entries. 
                       Your most used tag appears in @tagUsage.Values.Max() entries.</p>
                </div>
            </div>
        }

        <!-- Time Patterns -->
        <div class="analytics-section">
            <h3>
                <svg width="20" height="20" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                    <path d="M7 36.75V29.3125L30.0563 6.3C30.4063 5.95 30.8 5.6875 31.2375 5.5125C31.675 5.3375 32.1125 5.25 32.55 5.25C33.0167 5.25 33.4615 5.3375 33.8844 5.5125C34.3073 5.6875 34.6792 5.95 35 6.3L37.45 8.75C37.8 9.07083 38.0625 9.44271 38.2375 9.86563C38.4125 10.2885 38.5 10.7333 38.5 11.2C38.5 11.6375 38.4125 12.075 38.2375 12.5125C38.0625 12.95 37.8 13.3438 37.45 13.6938L14.4375 36.75H7ZM32.6375 13.6063L35 11.2437L32.5062 8.75L30.1438 11.1125L32.6375 13.6063ZM24.5 36.75C26.6583 36.75 28.6563 36.2104 30.4938 35.1313C32.3313 34.0521 33.25 32.55 33.25 30.625C33.25 29.575 32.9729 28.6708 32.4188 27.9125C31.8646 27.1542 31.1208 26.4979 30.1875 25.9437L27.6063 28.525C28.2771 28.8167 28.8021 29.1375 29.1813 29.4875C29.5604 29.8375 29.75 30.2167 29.75 30.625C29.75 31.2958 29.2177 31.901 28.1531 32.4406C27.0885 32.9802 25.8708 33.25 24.5 33.25C24.0042 33.25 23.5885 33.4177 23.2531 33.7531C22.9177 34.0885 22.75 34.5042 22.75 35C22.75 35.4958 22.9177 35.9115 23.2531 36.2469C23.5885 36.5823 24.0042 36.75 24.5 36.75ZM8.00625 23.3625L10.6313 20.7375C10.0479 20.5042 9.58854 20.2635 9.25313 20.0156C8.91771 19.7677 8.75 19.5125 8.75 19.25C8.75 18.9 9.0125 18.55 9.5375 18.2C10.0625 17.85 11.1708 17.3104 12.8625 16.5812C15.4292 15.4729 17.1354 14.4667 17.9813 13.5625C18.8271 12.6583 19.25 11.6375 19.25 10.5C19.25 8.89583 18.6083 7.61979 17.325 6.67188C16.0417 5.72396 14.35 5.25 12.25 5.25C10.9375 5.25 9.76354 5.48333 8.72813 5.95C7.69271 6.41667 6.89792 6.98542 6.34375 7.65625C6.02292 8.03542 5.89167 8.45833 5.95 8.925C6.00833 9.39167 6.22708 9.77083 6.60625 10.0625C6.98542 10.3833 7.40833 10.5146 7.875 10.4563C8.34167 10.3979 8.73542 10.2083 9.05625 9.8875C9.46458 9.47917 9.91667 9.1875 10.4125 9.0125C10.9083 8.8375 11.5208 8.75 12.25 8.75C13.4458 8.75 14.3281 8.925 14.8969 9.275C15.4656 9.625 15.75 10.0333 15.75 10.5C15.75 10.9083 15.4948 11.2802 14.9844 11.6156C14.474 11.951 13.3 12.5417 11.4625 13.3875C9.12917 14.4083 7.51042 15.3344 6.60625 16.1656C5.70208 16.9969 5.25 18.025 5.25 19.25C5.25 20.1833 5.49792 20.9781 5.99375 21.6344C6.48958 22.2906 7.16042 22.8667 8.00625 23.3625Z" fill="currentColor"/>
                </svg>
                Writing Patterns
            </h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-number">@mostProductiveMonth</div>
                    <div class="stat-label">Most Productive Month</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">@mostProductiveDayOfWeek</div>
                    <div class="stat-label">Most Active Day</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">@entriesThisMonth</div>
                    <div class="stat-label">Entries This Month</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">@entriesThisWeek</div>
                    <div class="stat-label">Entries This Week</div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">📊</div>
            <h3>No Data Yet</h3>
            <p>Start journaling to see your analytics and insights!</p>
        </div>
    }
</div>

@code {
    private List<JournalEntry> allEntries = new List<JournalEntry>();
    private List<Tag> allTags = new List<Tag>();
    private Dictionary<int, List<Tag>> entryTagsCache = new Dictionary<int, List<Tag>>();

    // Streak data
    private int currentStreak = 0;
    private int longestStreak = 0;
    private int totalDays = 0;
    private int missedDays = 0;
    private List<DateTime> last90Days = new List<DateTime>();

    // Mood data
    private Dictionary<string, int> moodDistribution = new Dictionary<string, int>();
    private string mostFrequentMood = "N/A";

    // Word count data
    private int totalWords = 0;
    private double averageWords = 0;
    private int maxWords = 0;
    private int minWords = 0;
    private List<JournalEntry> last30DaysEntries = new List<JournalEntry>();

    // Tag data
    private Dictionary<int, int> tagUsage = new Dictionary<int, int>();

    // Time patterns
    private string mostProductiveMonth = "N/A";
    private string mostProductiveDayOfWeek = "N/A";
    private int entriesThisMonth = 0;
    private int entriesThisWeek = 0;

    private int totalEntries = 0;

    private Dictionary<string, string> moodEmojis = new Dictionary<string, string>
    {
        { "Happy", "😊" }, { "Sad", "😢" }, { "Angry", "😠" },
        { "Anxious", "😰" }, { "Calm", "😌" }, { "Excited", "🤩" },
        { "Tired", "😴" }, { "Grateful", "🙏" }, { "Stressed", "😫" },
        { "Confused", "😕" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        allEntries = await DatabaseService.GetAllEntriesAsync();
        totalEntries = allEntries.Count;
        allTags = await DatabaseService.GetAllTagsAsync();

        if (!allEntries.Any())
            return;

        // Load tags for entries
        foreach (var entry in allEntries)
        {
            var tags = await DatabaseService.GetTagsForEntryAsync(entry.Id);
            entryTagsCache[entry.Id] = tags;
        }

        CalculateStreakData();
        CalculateMoodDistribution();
        CalculateWordCountStats();
        CalculateTagUsage();
        CalculateTimePatterns();
    }

    private void CalculateStreakData()
    {
        var entryDates = allEntries.Select(e => e.Date.Date).Distinct().OrderByDescending(d => d).ToList();
        totalDays = entryDates.Count;

        // Current streak
        var checkDate = DateTime.Today;
        currentStreak = 0;
        foreach (var date in entryDates)
        {
            if (date == checkDate)
            {
                currentStreak++;
                checkDate = checkDate.AddDays(-1);
            }
            else if (date < checkDate)
            {
                break;
            }
        }

        // Longest streak
        longestStreak = 0;
        int tempStreak = 0;
        DateTime? lastDate = null;

        foreach (var date in entryDates.OrderBy(d => d))
        {
            if (lastDate == null || date == lastDate.Value.AddDays(1))
            {
                tempStreak++;
                longestStreak = Math.Max(longestStreak, tempStreak);
            }
            else
            {
                tempStreak = 1;
            }
            lastDate = date;
        }

        // Missed days in last 30 days
        var last30Days = Enumerable.Range(0, 30).Select(i => DateTime.Today.AddDays(-i)).ToList();
        missedDays = last30Days.Count(d => !entryDates.Contains(d));

        // Last 90 days for heatmap
        last90Days = Enumerable.Range(0, 90).Select(i => DateTime.Today.AddDays(-89 + i)).ToList();
    }

    private void CalculateMoodDistribution()
    {
        moodDistribution.Clear();

        foreach (var entry in allEntries)
        {
            if (!string.IsNullOrEmpty(entry.PrimaryMood))
            {
                if (!moodDistribution.ContainsKey(entry.PrimaryMood))
                    moodDistribution[entry.PrimaryMood] = 0;
                
                moodDistribution[entry.PrimaryMood]++;
            }
        }

        if (moodDistribution.Any())
        {
            mostFrequentMood = moodDistribution.OrderByDescending(m => m.Value).First().Key;
        }
    }

    private void CalculateWordCountStats()
    {
        totalWords = allEntries.Sum(e => e.WordCount);
        averageWords = allEntries.Any() ? allEntries.Average(e => e.WordCount) : 0;
        maxWords = allEntries.Any() ? allEntries.Max(e => e.WordCount) : 0;
        minWords = allEntries.Any() ? allEntries.Min(e => e.WordCount) : 0;

        // Last 30 days entries
        var thirtyDaysAgo = DateTime.Today.AddDays(-30);
        last30DaysEntries = allEntries.Where(e => e.Date >= thirtyDaysAgo).OrderBy(e => e.Date).ToList();
    }

    private void CalculateTagUsage()
    {
        tagUsage.Clear();

        foreach (var entry in allEntries)
        {
            if (entryTagsCache.TryGetValue(entry.Id, out var tags))
            {
                foreach (var tag in tags)
                {
                    if (!tagUsage.ContainsKey(tag.Id))
                        tagUsage[tag.Id] = 0;
                    
                    tagUsage[tag.Id]++;
                }
            }
        }
    }

    private void CalculateTimePatterns()
    {
        // Most productive month
        var monthGroups = allEntries.GroupBy(e => e.Date.ToString("MMMM yyyy"))
            .OrderByDescending(g => g.Count())
            .FirstOrDefault();
        mostProductiveMonth = monthGroups?.Key ?? "N/A";

        // Most productive day of week
        var dayGroups = allEntries.GroupBy(e => e.Date.DayOfWeek)
            .OrderByDescending(g => g.Count())
            .FirstOrDefault();
        mostProductiveDayOfWeek = dayGroups?.Key.ToString() ?? "N/A";

        // Entries this month
        var startOfMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        entriesThisMonth = allEntries.Count(e => e.Date >= startOfMonth);

        // Entries this week
        var startOfWeek = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);
        entriesThisWeek = allEntries.Count(e => e.Date >= startOfWeek);
    }

    private string GetMoodEmoji(string mood)
    {
        return moodEmojis.TryGetValue(mood, out var emoji) ? emoji : "😐";
    }

    private string GetHeatmapClass(DateTime date)
    {
        if (!HasEntryOnDate(date))
            return "level-0";

        return "level-3"; // Can be enhanced to show word count intensity
    }

    private bool HasEntryOnDate(DateTime date)
    {
        return allEntries.Any(e => e.Date.Date == date.Date);
    }

    private string GetWordCountColor(int wordCount)
    {
        if (wordCount == 0) return "#e0e0e0";
        if (wordCount < 100) return "#90caf9";
        if (wordCount < 300) return "#42a5f5";
        if (wordCount < 500) return "#1e88e5";
        return "#1565c0";
    }
}